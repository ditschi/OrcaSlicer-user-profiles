# Profile Update Configuration (Optimized)
# This file contains JSON overwrite rules for updating slicer profiles with optimized settings

# JSON value overwrite rules
# These rules allow you to overwrite specific JSON keys based on conditions
# Each rule has:
#   - name: The JSON key to overwrite
#   - enabled: Whether this rule is active (default: true if not specified)
#   - value: The value to set (can be multiline string using | for G-code)
#   - add: Whether to add the key if it doesn't exist (default: false)
#   - conditions: (optional) List of conditions that must ALL match (AND logic)
#       - type: "filename_glob" - Match filename using glob pattern (e.g., *Kobra S1*.json)
#         pattern: Glob pattern for filename matching
#       - type: "filepath_glob" - Match relative file path using glob pattern (e.g., machine/*Kobra*.json)
#         pattern: Glob pattern for filepath matching
#       - type: "json_value" - Check if a JSON key has a specific value
#         key: The JSON key to check
#         value: The expected value (exact string match)


# Default conditions applied to ALL rules
default_conditions:
  - type: "json_value"
    key: "type"
    value: "machine_model"
    negate: true
  - type: "filename_glob"
    pattern: "*Kobra S1*"
  - type: "exclude_filepath_glob"
    pattern: "**/.copy_from_AnycubicSlicerNext/*"

json_value_overwrite:
  # ========================================
  # Global Settings (Applied to All Profiles)
  # ========================================

  # Set the "from" field to "User" for all profiles
  - name: "from"
    value: "User"

  - name: "thumbnails"
    value: "32x32/PNG, 400x300/PNG" # required by mainsail and fluidd
    conditions:
      - type: "filepath_glob"
        pattern: "**/machine/**"

  - name: "sparse_infill_pattern"
    value: "gyroid"
    conditions:
      - type: "filepath_glob"
        pattern: "**/process/**"

  - name: "brim_type"
    add: true
    value: "no_brim"
    conditions:
      - type: "filepath_glob"
        pattern: "**/process/**"

  - name: "host_type"
    add: true
    value: "octoprint"
    conditions:
      - type: "filepath_glob"
        pattern: "**/machine/**"

  - name: "print_host"
    add: true
    value: "http://192.168.1.246:4409"
    conditions:
      - type: "filepath_glob"
        pattern: "**/machine/**"

  - name: "print_host_webui"
    add: true
    value: "Anycubic Kobra S1 Combo"
    conditions:
      - type: "filepath_glob"
        pattern: "**/machine/**"


  # ========================================
  # G-code Overrides
  # ========================================

  # Machine Start G-code - Applied to all machine profiles
  - name: "machine_start_gcode"
    value: |
      ; ================================
      ; Begin of Machine Start G-code
      ; ================================
      ; Added as contained in AnycubicSlicerNext g-code to fix issues with error: The device cannot parse the file
      C X20000 Y20000 Z1000 E20000 ; Set maximum accelerations (mm/sec^2)
      M203 X600 Y600 Z15 E600 ; Set maximum feedrates (mm/sec) (mm/sec)
      M204 P20000 R20000 T20000 ; Set Starting Acceleration (mm/sec^2)
      M205 X15.00 Y15.00 Z15.00 E15.00 ; Set jerk limits (mm/sec)
      M106 S0 ; Turn off part cooling fan (Fan 0)
      M106 P2 S0 ; Turn off auxiliary fan (Fan 2)

      ; start of original Machine Start G-code
      G9111 bedTemp=[first_layer_bed_temperature] extruderTemp=[first_layer_temperature[initial_tool]]
      M117 Clear LCD display message
      ; end of original Machine Start G-code
      ; ================================
      ; End of Machine Start G-code
      ; ================================


  # Machine End G-code - Applied to all machine profiles
  - name: "machine_end_gcode"
    enabled: true
    value: |
      ; ================================
      ; Begin of Machine End G-code
      ; ================================
      G92 E0
      G1 E-2 F3000
      {if max_layer_z < max_print_height-1}G1 Z{z_offset+min(max_layer_z+2, max_print_height)} F900 ; Move print head further up{endif}
      G1 F12000; present print
      G1 X44;  throw_position_x
      G1 Y270; throw_position_y
      M140 S0 ; turn off heatbed
      M104 S0 ; turn off temperature
      M106 P1 S0 ; turn off fan
      M106 P2 S0
      M106 P3 S0
      M84; disable motors
      ; disable stepper motors
      ; ================================
      ; End of Machine End G-code
      ; ================================


  # Filament Change G-code - Applied only to "Optimized" machine profiles
  # Note: Disable this for "Original" profiles by setting enabled: true
  # or add condition to filter by filename
  - name: "change_filament_gcode"
    enabled: true
    value: |
      ; ================================
      ; Begin of filament change
      ; ================================
      ; NOTE: This manual sequence replaces the default firmware routine executed by:
      ;       T[next_extruder] in the original Kobra S1 profile
      ;       Original routine includes long retraction, slow XY/Z moves,
      ;       multi-pass purge/wipe, and long dwell times
      ;       This optimized version is faster and more efficient while safe

      ; 1. Retract old filament
      ; ----------------------
      ; Original firmware retracts a lot and waits a long time.
      ; Here we retract only as much as needed to safely remove the filament (~60 mm typical for Bowden path)
      G1 E-60 F600 ; retract 60mm at 10mm/s

      ; 2. Move to safe purge/wipe position
      ; -----------------------------------
      ; Original firmware moves very slowly, multiple Z lifts, long XY wipes
      G1 Z{toolchange_z+5} F1200 ; lift 5mm fast but safe
      G1 X260 Y25 F12000        ; fast travel to purge bucket / wipe area

      ; 3. Start heating for new filament (overlaps with filament change)
      ; -----------------------------------------------------------------
      ; Original firmware waits for full nozzle heat sequentially
      M104 S{next_filament_temp} ; set nozzle temp (non-blocking)
      ; Optional: preheat bed if needed (overlaps with movement)
      M140 S{first_layer_bed_temp} ; set bed temp (non-blocking)

      ; 4. Remove old filament manually (or via Rinkhals actuator)
      ; ----------------------------------------------------------
      ; Original firmware does automated unload + long dwell/ooze
      ; Here, operator or auto feeder removes old filament while hotend heats

      ; 5. Insert new filament
      ; ---------------------
      ; Feed new filament until it reaches nozzle
      G1 E10 F400 ; small initial extrusion to check flow
      ; Optional small back-and-forth wipe
      G1 Y1 F600
      G1 Y25 F3000

      ; 6. Purge minimal amount
      ; ----------------------
      ; Original firmware purges for 76s + 35s
      ; Here, we purge only enough to get clean filament at nozzle
      G1 E10 F400 ; extrude 10mm

      ; 7. Return to print height
      ; ------------------------
      ; Original firmware has extra Z moves and waits
      G1 Z{toolchange_z} F1200
      M400 ; wait for moves to finish
      ; ================================
      ; End of filament change
      ; ================================

  # ========================================
  # Machine Limits (Standardized Across All Nozzles)
  # ========================================
  # Applied to Optimized machine profiles only
  # These values reflect hardware capabilities and are identical regardless of nozzle size

  - name: "machine_max_acceleration_e"
    enabled: true
    value: ["20000", "20000"]


  - name: "machine_max_acceleration_retracting"
    enabled: true
    value: ["20000", "20000"]

  - name: "machine_max_acceleration_x"
    enabled: true
    value: ["20000", "20000"]

  - name: "machine_max_acceleration_y"
    enabled: true
    value: ["20000", "20000"]

  - name: "machine_max_acceleration_z"
    enabled: true
    value: ["1000", "1000"]

  - name: "machine_max_jerk_e"
    enabled: true
    value: ["15", "15"]

  - name: "machine_max_jerk_x"
    enabled: true
    value: ["15", "15"]

  - name: "machine_max_jerk_y"
    enabled: true
    value: ["15", "15"]

  - name: "machine_max_jerk_z"
    enabled: true
    value: ["15", "15"]

  - name: "machine_max_speed_e"
    enabled: true
    value: ["600", "600"]

  - name: "machine_max_speed_z"
    enabled: true
    value: ["15", "15"]

  # ========================================
  # Nozzle-Specific Settings (0.25mm)
  # ========================================
  # Flow-related parameters adjusted for 0.25mm nozzle

  - name: "retraction_speed"
    enabled: true
    value: ["30"]
    conditions:
      - type: "filename_glob"
        pattern: "*0.25 nozzle*"

  - name: "wipe_distance"
    enabled: true
    value: ["1"]
    conditions:
      - type: "filename_glob"
        pattern: "*0.25 nozzle*"

  - name: "retract_lift_above"
    enabled: true
    value: ["0"]
    conditions:
      - type: "filename_glob"
        pattern: "*0.25 nozzle*"

  # ========================================
  # Nozzle-Specific Settings (0.4mm)
  # ========================================
  # Flow-related parameters adjusted for 0.4mm nozzle

  - name: "retraction_speed"
    enabled: true
    value: ["40"]
    conditions:
      - type: "filename_glob"
        pattern: "*0.4 nozzle*"

  - name: "wipe_distance"
    enabled: true
    value: ["1"]
    conditions:
      - type: "filename_glob"
        pattern: "*0.4 nozzle*"

  - name: "retract_lift_above"
    enabled: true
    value: ["0"]
    conditions:
      - type: "filename_glob"
        pattern: "*0.4 nozzle*"

  # ========================================
  # Nozzle-Specific Settings (0.6mm)
  # ========================================
  # Flow-related parameters adjusted for 0.6mm nozzle

  - name: "retraction_speed"
    enabled: true
    value: ["40"]
    conditions:
      - type: "filename_glob"
        pattern: "*0.6 nozzle*"

  - name: "wipe_distance"
    enabled: true
    value: ["2"]
    conditions:
      - type: "filename_glob"
        pattern: "*0.6 nozzle*"

  - name: "retract_lift_above"
    enabled: true
    value: ["0"]
    conditions:
      - type: "filename_glob"
        pattern: "*0.6 nozzle*"

  # ========================================
  # Nozzle-Specific Settings (0.8mm)
  # ========================================
  # Flow-related parameters adjusted for 0.8mm nozzle

  - name: "retraction_speed"
    enabled: true
    value: ["40"]
    conditions:
      - type: "filename_glob"
        pattern: "*0.8 nozzle*"

  - name: "wipe_distance"
    enabled: true
    value: ["2"]
    conditions:
      - type: "filename_glob"
        pattern: "*0.8 nozzle*"

  - name: "retract_lift_above"
    enabled: true
    value: ["0"]
    conditions:
      - type: "filename_glob"
        pattern: "*0.8 nozzle*"

  # ========================================
  # Example: Custom rules
  # ========================================
  # Uncomment and modify as needed
  # - name: "some_custom_field"
  #   enabled: false
  #   value: "custom_value"
  #   add: true  # Add key if it doesn't exist
  #   conditions:
  #     - type: "filename_glob"
  #       pattern: "*Kobra S1*.json"  # Match any file with "Kobra S1" in the name
  #     - type: "filepath_glob"
  #       pattern: "machine/*.json"  # Match files in machine/ directory
  #     - type: "json_value"
  #       key: "type"
  #       value: "process"
